
# 9.7.18 视频指令（Video Instructions）

> 章节对照：https://docs.nvidia.com/cuda/parallel-thread-execution/#video-instructions  
> 说明：本文件提供**指令索引 + 使用要点**，完整语义以官方文档为准。

## 快速索引（本节覆盖指令）
- `vadd4`, `vsub4`, `vavrg4`
- `vabsdiff4`, `vmin4`, `vmax4`
- `vset4`

---

## 通用特性

- **数据布局**：操作数为 32 位整数（`.u32` 或 `.s32`），内部解释为 4 个连续的 8 位字节（通道 0 = 低字节，通道 3 = 高字节）。
- **向量隐式处理**：无需显式 `.v4` 后缀；指令本身即表示 4 通道 SIMD 操作。
- **饱和支持**：仅 `vadd4` 和 `vsub4` 支持 `.sat` 修饰符，用于自动钳位结果至 `[0, 255]`。
- **符号性**：部分指令支持混合符号操作（如 `vadd4.s32.u32.u32.sat`）。
- **非浮点**：所有视频指令均为整数操作，不涉及浮点运算。

---

## 支持的指令列表

| 指令 | 功能 | 饱和 | 架构 |
|------|------|------|------|
| `vadd4`      | 四通道字节加法                | 可选（`.sat`） | sm_30+ |
| `vsub4`      | 四通道字节减法                | 可选（`.sat`） | sm_30+ |
| `vavrg4`     | 四通道无偏平均（`(a + b) >> 1`） | 否             | sm_30+ |
| `vabsdiff4`  | 四通道绝对差值（`\|a - b\|`）   | 否             | sm_30+ |
| `vmin4`      | 四通道最小值（`min(a, b)`）     | 否             | sm_30+ |
| `vmax4`      | 四通道最大值（`max(a, b)`）     | 否             | sm_30+ |
| `vset4`      | 四通道比较（结果为 0/1）        | 否             | sm_30+ |

> ⚠️ 注意：`dp4a`、`dp2a` 等点积指令属于 **“Integer Arithmetic Instructions”**（§9.7.2），**不属于本节视频指令**。

---

## 指令详解

### 1. `vadd4` — 四通道字节加法（可选饱和）

```ptx
vadd4{.type}.sat d, a, b;
```

- **类型**：`.u32` 或 `.s32`（影响输入解释，但输出始终为无符号字节）
- **功能**：
  ```c
  for (i = 0; i < 4; i++) {
      uint16_t sum = byte_i(a) + byte_i(b);
      d[i] = .sat ? min(sum, 255) : (sum & 0xFF);
  }
  ```
- **用途**：图像合成、亮度增强、alpha 混合预处理
- **示例**：
  ```ptx
  vadd4.u32.sat %r1, %r2, %r3;  // 饱和加法
  ```

---

### 2. `vsub4` — 四通道字节减法（可选饱和）

```ptx
vsub4{.type}.sat d, a, b;
```

- **功能**：`d[i] = max(0, a[i] - b[i])`（若使用 `.sat`）
- **用途**：运动检测、色度键抠图、图像差分
- **注意**：即使不使用 `.sat`，结果仍为无符号字节（负值截断为 0~255 循环）

---

### 3. `vavrg4` — 四通道无偏平均

```ptx
vavrg4{.type} d, a, b;
```

- **功能**：`d[i] = (a[i] + b[i]) >> 1`（等价于 `(a + b) / 2` 向下取整）
- **无舍入误差**：因使用位移而非除法，避免浮点或余数问题
- **用途**：图像缩放、帧间插值、运动补偿

---

### 4. `vabsdiff4` — 四通道绝对差值

```ptx
vabsdiff4{.type} d, a, b;
```

- **功能**：`d[i] = |a[i] - b[i]|`
- **用途**：块匹配、运动估计、图像相似度计算

---

### 5. `vmin4` / `vmax4` — 四通道极值

```ptx
vmin4{.type} d, a, b;  // d[i] = min(a[i], b[i])
vmax4{.type} d, a, b;  // d[i] = max(a[i], b[i])
```

- **用途**：对比度调整、形态学操作（如膨胀/腐蚀）、HDR 融合

---

### 6. `vset4` — 四通道比较（核心复杂指令）

```ptx
vset4{.pred}.type.op{.merge|.add} d, a, b, c;
```

#### 基本形式
- **比较操作符 `.op`**：`.eq`, `.ne`, `.lt`, `.le`, `.gt`, `.ge`
- **结果**：每个字节的 **最低有效位（LSB）** 为 1（真）或 0（假），其余位为 0。
  - ❌ **不是 0xFF/0x00**！这是常见误解。
  - 示例：若通道 0 比较为真，则 `d[0] = 0x01`，非 `0xFF`。

#### 二次操作模式
| 修饰符 | 行为 |
|--------|------|
| （无） | `d[i] = (a[i] op b[i]) ? 1 : 0` |
| `.merge` | `d[i] = (a[i] op b[i]) ? 1 : c[i]`（掩码合并） |
| `.add`   | `d = c + Σ_{i=0..3} ((a[i] op b[i]) ? 1 : 0)`（标量累加）|

#### 字节重排（Byte Selection）
- 可通过 `.asel` / `.bsel` 修饰符从源操作数的 **任意 8 字节窗口** 中选择 4 字节参与比较：
  ```ptx
  vset4.u32.eq.asel.bsel d, a, b, c;
  ```
  - 允许跨寄存器或非对齐像素访问，提升灵活性。

#### 示例
```ptx
// 基本比较：结果为 0x01000100（通道0和2相等）
vset4.u32.eq %r1, %r2, %r3, %r0;

// 掩码合并：保留原值或设为1
vset4.u32.eq.merge %r1, %r2, %r3, %r4;

// 累加真值数量（0~4）
vset4.u32.eq.add %r1, %r2, %r3, %r4;
```

---

## 典型应用场景

| 指令 | 应用 |
|------|------|
| `vadd4` / `vsub4` | 图像合成、色键、亮度/对比度调整 |
| `vavrg4`          | 视频帧插值、降噪（时域平均） |
| `vabsdiff4`       | 运动估计、块匹配、异常检测 |
| `vmin4` / `vmax4` | 形态学滤波、局部极值检测 |
| `vset4`           | 条件像素处理、区域掩码生成、统计计数 |

---

## 重要注意事项

1. **无 `vmad` 指令**：PTX ISA 中不存在名为 `vmad` 或 `vmad2` 的指令。Hopper 架构（sm_90）引入的是 `wgmma`（Warpgroup MMA）用于矩阵运算，与视频指令无关。
2. **`dp4a` 不属于本节**：尽管常用于 INT8 推理和视频处理，但 `dp4a` 在官方文档中归类于 **整数算术指令**（§9.7.2）。
3. **结果精度**：`vset4` 输出为 **1-bit 布尔值（0/1）**，若需 0xFF/0x00 掩码，需后续用 `shl.b32` 或 `selp` 扩展。
4. **性能提示**：这些指令由 **专用 SIMD 单元** 执行，通常具有高吞吐、低延迟特性，适合像素级并行处理。

---

## 参考

- NVIDIA PTX ISA Documentation, Section 9.7.18: [Video Instructions](https://docs.nvidia.com/cuda/parallel-thread-execution/index.html#video-instructions)
- CUDA Toolkit Documentation, Compute Capability Appendix

--- 

如需严格语义与边界条件，请以官方文档为准。