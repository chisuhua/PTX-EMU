cmake_minimum_required(VERSION 3.15)

# ==============================
# ğŸ”§ å…³é”®ï¼šåœ¨ project() å‰è®¾ç½® CUDA æ ‡å‡†å¹¶å¯ç”¨è¯­è¨€
# ==============================
set(CMAKE_CUDA_STANDARD 20)
set(CMAKE_CUDA_STANDARD_REQUIRED ON)
set(CMAKE_CUDA_EXTENSIONS OFF)
enable_language(CUDA)

# ==============================
# ğŸ“¦ é¡¹ç›®å®šä¹‰ï¼ˆåŒ…å« CXX å’Œ CUDAï¼‰
# ==============================
project(PTX-EMU LANGUAGES CXX CUDA)

# ==============================
# ğŸ› ï¸ å…¨å±€è®¾ç½®
# ==============================
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_INSTALL_RPATH_USE_LINK_PATH ON)

# é»˜è®¤æ„å»ºç±»å‹
if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Release CACHE STRING "Build type" FORCE)
endif()

# æ—¥å¿—é€‰é¡¹
option(USE_DETAILED_LOGGING "Use detailed logging with file location info" OFF)
if(USE_DETAILED_LOGGING)
    add_compile_definitions(PTXSIM_USE_DETAILED_LOGGING)
endif()

# è¾“å‡ºç›®å½•
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)

# ==============================
# ğŸ” æŸ¥æ‰¾ä¾èµ–
# ==============================
find_package(Java COMPONENTS Runtime REQUIRED)
find_package(CUDAToolkit REQUIRED)

# CUDA æ¶æ„ï¼ˆå¯é€‰ï¼‰
set(DEFAULT_CUDA_ARCH "100" CACHE STRING "Default CUDA architecture")

# ==============================
# ğŸœ ANTLR4 é…ç½®
# ==============================
set(ANTLR_EXECUTABLE ${CMAKE_SOURCE_DIR}/antlr4/antlr-4.11.1-complete.jar)
set(ANTLR4_RUNTIME_SOURCE_DIR ${CMAKE_SOURCE_DIR}/antlr4/antlr4-cpp-runtime-4.13.1-source/runtime/Cpp)
set(ANTLR4_GENERATED_SRC_DIR ${CMAKE_CURRENT_BINARY_DIR}/antlr4_generated_src)

file(MAKE_DIRECTORY ${ANTLR4_GENERATED_SRC_DIR})

# ğŸ”¥ å…³é”®ï¼šç¦ç”¨ ANTLR4 çš„æµ‹è¯•å’Œ demoï¼Œé¿å…ä¸‹è½½ googletest
set(ANTLR4_BUILD_TESTS OFF CACHE BOOL "Disable ANTLR4 tests" FORCE)
set(ANTLR_BUILD_CPP_TESTS OFF CACHE BOOL "Disable ANTLR4 tests" FORCE)
set(WITH_DEMO OFF CACHE BOOL "Disable ANTLR4 demo" FORCE)

# æ„å»º ANTLR4 è¿è¡Œæ—¶
add_subdirectory(
    ${ANTLR4_RUNTIME_SOURCE_DIR}
    ${CMAKE_CURRENT_BINARY_DIR}/antlr4_runtime
)

# åŒ…å«å¤´æ–‡ä»¶ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼Œå»ºè®®åç»­æ”¹ç”¨ target_include_directoriesï¼‰
include_directories(${ANTLR4_RUNTIME_SOURCE_DIR}/runtime/src)
include_directories(${ANTLR4_GENERATED_SRC_DIR})
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/external/json)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/external/inipp)

set(ANTLR4_LIBRARY antlr4_shared)

# ==============================
# ğŸ“ å­ç›®å½•
# ==============================
add_subdirectory(src)

# å¯ç”¨æµ‹è¯•ï¼ˆä½†ç¡®ä¿ tests/CMakeLists.txt ä¸å† enable_language(CUDA)ï¼‰
enable_testing()
add_subdirectory(tests)

# å¯é€‰ benchmark
if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/bench/cute/CMakeLists.txt)
    add_subdirectory(bench/cute)
endif()

# ==============================
# ğŸ“¤ å®‰è£…è§„åˆ™
# ==============================
install(DIRECTORY lib/
        DESTINATION lib
        FILES_MATCHING PATTERN "*.so*")

install(DIRECTORY bin/
        DESTINATION bin
        FILES_MATCHING PATTERN "*")